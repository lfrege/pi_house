var myl = require('mysqlLink');
var http = require('http');

postQueryResult = function(row, msgbody)
{
	var postObj = JSON.parse(msgbody);
	postObj.ipaddr = row.ipaddr;

	if (row.hostname != postObj.hostname)
	{
		myl.updateHostname(row.ipaddr, postObj.hostname);
	}

	myl.insertPing(postObj);
}


queryHostRow = function(row)
{
	var ip = row.ipaddr;

	http.get({host: ip, path: "/status", port: 18082}, function(res)
	{
		var msgbody = "";
		console.log("status for " + ip + ": " + res.statusCode);
		res.setEncoding('utf8');
		res.on('data',function(chunk)
		{
			msgbody += chunk;
			postQueryResult(row, msgbody);
//			console.log("from " + ip + ": " + msgbody);
		});
	}).on('error', function(e)
	{
//		console.log("Eror from " + ip + ": " + e.code);
	});
}

queryHostList = function()
{
	myl.getHosts(function(err, rows, fields)
	{
		if (err)
		{
			console.log(JSON.stringify(err));
		}
		else
		{
			for (i = 0; i < rows.length; i++)
			{
				queryHostRow(rows[i]);
			}
		}
	});
}


startQueries = function()
{
	setInterval(queryHostList, 30000);
}


module.exports.startQueries = startQueries;
