var mysql = require('mysql');

var server = "127.0.0.1";
var user = "pi";
var password = "pihouse";
var database = "pihouse";

const add_net_error_table = "CREATE TABLE net_error ( "
	+"host_id	INTEGER NOT NULL, "
	+"created	TIMESTAMP DEFAULT CURRENT_TIMESTAMP, "
	+"FOREIGN KEY net_error(host_id) REFERENCES hosts(host_id))";

const add_host_change_table = "CREATE TABLE host_change ( "
	+"host_id	INTEGER NOT NULL, "
	+"hostname	VARCHAR(50), "
	+"platform 	VARCHAR(50), "
	+"totalmem	BIGINT, "
	+"created	TIMESTAMP DEFAULT CURRENT_TIMESTAMP, "
	+"FOREIGN KEY host_change(host_id) REFERENCES hosts(host_id))";

const add_ping_table = "CREATE TABLE ping ( "
	+"host_id 	INTEGER NOT NULL, "
	+"load1		DOUBLE, "
	+"load2		DOUBLE, "
	+"load3		DOUBLE, "
	+"freemem	BIGINT, "
	+"created	TIMESTAMP DEFAULT CURRENT_TIMESTAMP, "
	+"FOREIGN KEY ping(host_id) REFERENCES hosts(host_id))";
	+") ";

const add_hosts_table = "CREATE TABLE hosts ( "
	+"host_id 	INTEGER PRIMARY KEY AUTO_INCREMENT, "
	+"hostname 	VARCHAR(50), "
	+"platform 	VARCHAR(50), "
	+"totalmem	BIGINT, "
	+"ipaddr	VARCHAR(30) UNIQUE, "
	+"created	TIMESTAMP DEFAULT CURRENT_TIMESTAMP "
	+")";

const drop_hosts_table = "DROP TABLE hosts";
const drop_ping_table = "DROP TABLE ping";
const drop_host_change_table = "DROP TABLE host_change";
const drop_net_error_table = "DROP TABLE net_error";

const read_hosts = "SELECT * FROM hosts";

genericMySQLReturn = function(err,rows,fields)
{
	if (err)
	{
		console.log(JSON.stringify(err));
		console.log(JSON.stringify(rows));
		console.log(JSON.stringify(fields));
	}
}

postNetError = function(ipaddress)
{
	var statement = "INSERT INTO net_error(host_id) "
		+"SELECT host_id FROM hosts WHERE ipaddr='" + ipaddress + "'";
	var connection = mysql.createConnection({host: server, user: user, password: password, database:database});

	connection.query(statement, genericMySQLReturn);

	connection.end();
}

addTables = function()
{
	var connection = mysql.createConnection({host: server, user: user, password: password, database:database});

	connection.query(drop_net_error_table, genericMySQLReturn);
	connection.query(drop_ping_table, genericMySQLReturn);
	connection.query(drop_host_change_table, genericMySQLReturn);
	connection.query(drop_hosts_table, genericMySQLReturn);
	connection.query(add_hosts_table, genericMySQLReturn);
	connection.query(add_ping_table, genericMySQLReturn);
	connection.query(add_host_change_table, genericMySQLReturn);
	connection.query(add_net_error_table, genericMySQLReturn);

	connection.end();
}

getHosts = function(callback)
{
	var connection = mysql.createConnection({host: server, user: user, password: password, database:database});

	connection.query(read_hosts, callback);

	connection.end();
}

addHost = function(ip)
{
	var connection = mysql.createConnection({host: server, user: user, password: password, database:database});

	connection.query("INSERT INTO hosts(ipaddr) VALUES ('" + ip + "')", genericMySQLReturn);

	connection.end();
}

updateHostname = function(ipaddr, hostname, platform, totalmem)
{
	var connection = mysql.createConnection({host: server, user: user, password: password, database:database});
	var change_stmt = "INSERT INTO host_change (host_id, hostname, platform, totalmem) "
		+ "SELECT host_id, '" + hostname + "', '" + platform + "', '" + totalmem + "'" 
		+ " FROM hosts WHERE ipaddr='" + ipaddr + "' ";

	connection.query("UPDATE hosts SET hostname='" + hostname + "', platform='" + platform  + "', totalmem='" + totalmem + "' WHERE ipaddr='" + ipaddr + "'");
	connection.query(change_stmt);

	connection.end();
}

insertPing = function(postObj)
{
	var statement = "INSERT INTO ping (host_id, load1, load2, load3, freemem) "
		+ "SELECT host_id, '" + postObj.load[0] + "', '" + postObj.load[1] + "', '" + postObj.load[2] + "', '" + postObj.freemem + "' " 
		+ " FROM hosts WHERE ipaddr='" + postObj.ipaddr + "' ";

	var connection = mysql.createConnection({host: server, user: user, password: password, database:database});

	connection.query(statement, genericMySQLReturn);

	connection.end();
}

module.exports.postNetError = postNetError;
module.exports.insertPing = insertPing;
module.exports.updateHostname = updateHostname;
module.exports.addHost = addHost;
module.exports.addTables = addTables;
module.exports.getHosts = getHosts;
