var myl = require('mysqlLink');
var url = require('url');
var strTools = require('strTools');

makeHostPage = function(err, rows, fields, req, res)
{
	res.writeHead(200, {'Content-Type': 'text/html'});
	res.write("<html>\n<head><title>Host List</title></head>\n<body>\n");

	if (err)
	{
		res.write('<div class="errorOutput">' + JSON.stringify(err) + '</div>');
		res.write("</body></html>");
		res.end();
		return;
	}

	res.write("<table>\n\t<tr><th>ID</th><th>host</th><th>ip address</th><th>platform</th><th>totalmem</th><th>created</th></tr>\n");
	for (i=0; i < rows.length; i++)
	{
		res.write("\t<tr><td>" + rows[i].host_id 
			+ "</td><td>" + rows[i].hostname 
			+ "</td><td>" + rows[i].ipaddr
			+ "</td><td>" + rows[i].platform 
			+ "</td><td>" + rows[i].totalmem 
			+ "</td><td>" + rows[i].created 
			+ "</td></tr>\n");
	}
	res.write("</table>\n");

	res.write("</body>\n</html>");
	res.end();
}

hostsList = function(req,res)
{
	var ip = url.parse(req.url, true).query['add'];

	if (strTools.isIP(ip))
	{
		myl.addHost(ip);
	}

	myl.getHosts(function(err, rows, fields)
	{
		makeHostPage(err,rows,fields,req,res);
	});

}


handleRequest = function(req, res)
{
	var key;
	var urldata = url.parse(req.url, true);
	if (urldata.pathname == "/hosts" || urldata.pathname == "/hosts/")
	{
		hostsList(req,res);
	}
	else
	{
		res.writeHead(200, {'Content-Type': 'text/html'});
		res.write("<br/>\n" + JSON.stringify(urldata));
		res.end();
	}
}

module.exports.handleRequest = handleRequest;
